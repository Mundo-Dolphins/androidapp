name: Android CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    name: Build, static analysis and tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Prepare google-services.json (from secret or repo)
        env:
          DATA: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          set -euo pipefail

          # If secret provided: try decode base64, otherwise write raw
          if [ -n "${DATA:-}" ]; then
            mkdir -p app
            if printf '%s' "$DATA" | base64 --decode >/tmp/gs_decoded 2>/dev/null; then
              first_char=$(head -c 1 /tmp/gs_decoded || true)
              if [ "$first_char" = "{" ] || [ "$first_char" = "[" ]; then
                mv /tmp/gs_decoded app/google-services.json
              else
                rm -f /tmp/gs_decoded
                printf '%s' "$DATA" > app/google-services.json
              fi
            else
              printf '%s' "$DATA" > app/google-services.json
            fi
            echo "Wrote app/google-services.json (size: $(wc -c < app/google-services.json) bytes)"

          # No secret: use checked-in file if present, otherwise fail
          elif [ -f app/google-services.json ]; then
            echo "Using checked-in app/google-services.json"

          else
            echo "ERROR: app/google-services.json missing and GOOGLE_SERVICES_JSON secret not set" >&2
            exit 1
          fi

          # Quick JSON validation (fail if malformed)
          if [ -f app/google-services.json ]; then
            python3 -m json.tool app/google-services.json > /dev/null
          fi

      - name: Get Gradle wrapper version
        id: gradle_version
        run: |
          set -euo pipefail
          version="unknown"
          if [ -f gradle/wrapper/gradle-wrapper.properties ]; then
            # extract distributionUrl and get the gradle version portion
            dist=$(grep -E '^distributionUrl=' gradle/wrapper/gradle-wrapper.properties || true)
            if [ -n "$dist" ]; then
              # capture like gradle-7.4.2 or gradle-8.0
              ver=$(echo "$dist" | sed -E 's#.*gradle-([0-9]+(\.[0-9]+)*(-[^/]+)?).*#\1#;s/\r//g')
              if [ -n "$ver" ]; then
                version="$ver"
              fi
            fi
          fi
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.gradle/caches/build-cache-1
            ~/.gradle/wrapper/dists
            ~/.gradle/caches/modules-2/files-2
            ~/.m2/repository
            .gradle
            app/.gradle
          key: ${{ runner.os }}-gradle-${{ steps.gradle_version.outputs.version }}-${{ hashFiles('**/*.gradle*','**/gradle-wrapper.properties','gradle.properties','settings.gradle*','gradle/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Run static analysis, build and tests
        run: |
          chmod +x gradlew
          # Run static analysis; fail the step if ktlint/detekt report issues
          ./gradlew :app:ktlintCheck :app:detekt --console=plain --info --stacktrace --parallel --build-cache

          # Build and run unit tests (this should fail the job on error)
          ./gradlew clean assembleDebug :app:testDebugUnitTest --console=plain --info --stacktrace --parallel --build-cache

      - name: Upload CI reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-reports
          path: |
            app/build/reports/tests/testDebugUnitTest
            app/build/test-results/testDebugUnitTest
            app/build/reports/detekt
            app/build/reports/ktlint

      - name: Print test summary
        if: always()
        run: |
          echo "Artifacts uploaded: ci-reports"
